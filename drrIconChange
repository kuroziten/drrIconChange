



const girl = createImg("http://drrrkari.com/css/icon_girl.png", "girl");
const moza = createImg("http://drrrkari.com/css/icon_moza.png", "moza");
const tanaka = createImg("http://drrrkari.com/css/icon_tanaka.png", "tanaka");
const kanra = createImg("http://drrrkari.com/css/icon_kanra.png", "kanra");
const usa = createImg("http://drrrkari.com/css/icon_usa.png", "usa");
const gg = createImg("http://drrrkari.com/css/icon_gg.png", "gg");
const orange = createImg("http://drrrkari.com/css/icon_orange.png", "orange");
const zaika = createImg("http://drrrkari.com/css/icon_zaika.png", "zaika");
const setton = createImg("http://drrrkari.com/css/icon_setton.png", "setton");
const zawa = createImg("http://drrrkari.com/css/icon_zawa.png", "zawa");
const neko = createImg("http://drrrkari.com/css/icon_neko.png", "neko");
const purple = createImg("http://drrrkari.com/css/icon_purple.png", "purple");
const kai = createImg("http://drrrkari.com/css/icon_kai.png", "kai");
const bakyura = createImg("http://drrrkari.com/css/icon_bakyura.png", "bakyura");
const neko2 = createImg("http://drrrkari.com/css/icon_neko2.png", "neko2");
const numakuro = createImg("http://drrrkari.com/css/icon_numakuro.png", "numakuro");
const bm = createImg("http://drrrkari.com/css/icon_bm.png", "bm");
const bear = createImg("http://drrrkari.com/css/icon_bear.png", "bear");
const rab = createImg("http://drrrkari.com/css/icon_rab.png", "rab");
const nyan = createImg("http://drrrkari.com/css/icon_nyan.png", "nyan");
const muff = createImg("http://drrrkari.com/css/icon_muff.png", "muff");
const muff_nyan = createImg("http://drrrkari.com/css/icon_muff_nyan.png", "muff_nyan");

const pop = document.createElement("div");
pop.style.position = "fixed";
pop.style.width = "90vw";
pop.style.height = "80vh";
pop.style.left = "5vw";
pop.style.top = "10vh";
pop.style.backgroundColor = "white";
document.getElementsByTagName("html")[0].append(pop);
document.getElementsByClassName("message_box")[0].style.zIndex = "0";
pop.append(girl);
pop.append(moza);
pop.append(tanaka);
pop.append(kanra);
pop.append(usa);
pop.append(gg);
pop.append(orange);
pop.append(zaika);
pop.append(setton);
pop.append(zawa);
pop.append(neko);
pop.append(purple);
pop.append(kai);
pop.append(bakyura);
pop.append(neko2);
pop.append(numakuro);
pop.append(bm);
pop.append(bear);
pop.append(rab);
pop.append(nyan);
pop.append(muff);
pop.append(muff_nyan);

function createImg (url, name) {
    const img = document.createElement("img");
    img.src = url;
    img.style.width = "8%";
    img.style.padding = "1%";
    img.onclick = function () {iconChange(name)};
    return img;
}








function iconChange (iconName) {
    const roomName = document.getElementsByName("room_name")[0].value;
    const userName = document.getElementsByClassName("profname")[0].innerHTML;
    
    $.cookie('durarara-like-chat1',"",{path:"/",expires:-1});
    
    $.ajax('http://drrrkari.com/logout/',
      {
        type: 'post'
      }
    )
    .done(function(data) {
        console.log("done");
        const html = data;
        const div = document.createElement("div");
        div.innerHTML = html;
        document.getElementsByTagName("html")[0].appendChild(div);
        const tokenLast = document.getElementsByName("token").length - 1;
        console.log(tokenLast);
        if (tokenLast > -1) {
            console.log("in");
            const token = document.getElementsByName("token")[tokenLast].value;
            console.log("token : " + token);
    
            $.ajax('http://drrrkari.com/',
              {
                type: 'post',
                data: {name : userName, login : "login", language : "ja-JP", icon : iconName, token : token}
              }
            )
            .done(function(data2) {
                const html2 = data2;
                document.getElementsByTagName("html")[0].innerHTML = data2;
                console.log(data2);
                const div2 = document.createElement("div");
                div2.innerHTML = html2;
                document.getElementsByTagName("html")[0].innerHTML = "";
                document.getElementsByTagName("html")[0].appendChild(div2);
                console.log(getRoomId(roomName, userName));
    
    
    
    
    
                
                $.ajax('http://drrrkari.com/room/',
                  {
                    type: 'post',
                    data: {id : getRoomId(roomName, userName), login : "login"}
                  }
                )
                .done(function(data2) {
                    console.log("成功？");
                    location.reload();
                });
    
    
    
    
    
                
                
            });
        } else {
            console.log("tokenが取得出来ませんでした。");
        }
    });    
}




function getRoomId (roomName, userName) {
    const names = document.getElementsByClassName("name");
    let breakFlg = false;
    let id = "";
    for (i = 0; i < names.length; i++) {
        console.log("loop i :" + i);
        
        const name = names[i];
        if (name.innerHTML == roomName)　{
            const next = name.nextElementSibling.getElementsByTagName("li");
            for (i2 = 0; i2 < next.length; i2++) {
                console.log("loop i2 :" + i2);

                e = next[i2];
                if (e.getElementsByTagName("img").length > 0) {
                    e.getElementsByTagName("img")[0].remove();
                }
                if (next[i2].innerHTML == userName) {
                    console.log("ヒットしました");
                    breakFlg = true;
                    id = name.nextElementSibling.nextElementSibling.nextElementSibling.getElementsByTagName("input")[0].value;
                    break;
                }
            }
            if (breakFlg) break;
        }
    }
    console.log(id);
    return id;
}
